# Copyright 2020 Changkun Ou. All rights reserved.
# Use of this source code is governed by a GPL-3.0
# license that can be found in the LICENSE file.

http:
  routers:
    # github.com/changkun/login
    to-login:
      rule: Host(`login.changkun.de`)
      tls:
        certResolver: changkunResolver
      service: login
    # github.com/changkun/main
    to-main:
      rule: Host(`changkun.de`, `ou.changkun.de`, `www.changkun.de`)
      tls:
        certResolver: changkunResolver
      middlewares:
        - gzipcompress
        - main-errorpages
      service: main
    # github.com/changkun/talks
    to-talks:
      rule: Host(`changkun.de`, `ou.changkun.de`, `www.changkun.de`)&&(Path(`/talks`)||PathPrefix(`/talks/`))
      tls:
        certResolver: changkunResolver
      middlewares:
        - main-errorpages
      service: talks
    # github.com/changkun/modern-cpp-tutorial
    to-nginx:
      rule: Host(`changkun.de`, `ou.changkun.de`, `www.changkun.de`)&&(Path(`/modern-cpp`)||PathPrefix(`/modern-cpp/`)||PathPrefix(`/consent`)||PathPrefix(`/demos/`))
      tls:
        certResolver: changkunResolver
      middlewares:
        - gzipcompress
        - main-errorpages
      service: nginx
    # github.com/changkun/blog
    to-blog:
      rule: Host(`blog.changkun.de`)
      tls:
        certResolver: changkunResolver
      middlewares:
        - gzipcompress
        - blog-errorpages
      service: blog
    to-us:
      rule: Host(`changkun.us`, `www.changkun.us`, `ou.changkun.us`)
      tls:
        certResolver: changkunResolver
      middlewares:
        - us-redirector
      service: blog
    to-info:
      rule: Host(`changkun.info`, `www.changkun.info`, `ou.changkun.info`)
      tls:
        certResolver: changkunResolver
      middlewares:
        - info-redirector
      service: blog
    to-urlstat:
      rule: Host(`changkun.de`, `ou.changkun.de`, `www.changkun.de`)&&PathPrefix(`/urlstat`)
      tls:
        certResolver: changkunResolver
      middlewares:
        - main-errorpages
      service: urlstat
    # github.com/changkun/redir
    to-redir:
      rule: Host(`changkun.de`, `ou.changkun.de`, `www.changkun.de`)&&(Path(`/{redir:[srx]}`)||PathPrefix(`/{redir:[srx]}/`))
      tls:
        certResolver: changkunResolver
      middlewares:
        - main-errorpages
      service: redir

    # github.com/changkun/void
    to-void:
      rule: Host(`changkun.de`, `ou.changkun.de`, `www.changkun.de`)&&(Path(`/void`)||PathPrefix(`/void/`))
      service: void
      tls:
        certResolver: changkunResolver

    # github.com/changkun/midgard
    to-midgard:
      rule: Host(`changkun.de`, `ou.changkun.de`, `www.changkun.de`)&&PathPrefix(`/midgard`)
      tls:
        certResolver: changkunResolver
      middlewares:
        - main-errorpages
      service: midgard
    # github.com/changkun/upbot
    to-upbot:
      rule: Host(`changkun.de`, `ou.changkun.de`, `www.changkun.de`)&&PathPrefix(`/upbot`)
      tls:
        certResolver: changkunResolver
      middlewares:
        - main-errorpages
      service: upbot
    # github.com/changkun/go-under-the-hood
    to-golang:
      rule: Host(`changkun.de`, `ou.changkun.de`, `www.changkun.de`)&&(PathPrefix(`/golang`)
      tls:
        certResolver: changkunResolver
      middlewares:
        - golang-redirector
      service: main
    # github.com/golang-design/ssaplayground
    to-gossa:
      rule: Host(`changkun.de`, `ou.changkun.de`, `www.changkun.de`, `golang.design`, `www.golang.design`)&&(Path(`/gossa`)||PathPrefix(`/gossa/`))
      tls:
        certResolver: changkunResolver
      service: gossa
    dashboard:
      rule: Host(`traefik.changkun.de`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))
      service: api@internal
      tls:
        certResolver: changkunResolver
      middlewares:
        - auth
    # github.com/polyred/server
    to-polyred:
      rule: "Host(`poly.red`)"
      tls:
        certResolver: polyredResolver
      middlewares:
        - gzipcompress
        # - main-errorpages # TODO: add error handler
      service: polyred
    to-code2img:
      rule: Host(`golang.design`, `www.golang.design`) && PathPrefix(`/api/v1/code2img`)
      service: code2img
      tls:
        certResolver: golangdesignResolver
      middlewares:
        - golang-errorpages
    to-golangdesign-redir:
      rule: Host(`golang.design`, `www.golang.design`) && (Path(`/{golangdesign-redir:[srx]}`)||PathPrefix(`/{golangdesign-redir:[srx]}/`))
      service: golangdesign-redir
      tls:
        certResolver: golangdesignResolver
      middlewares:
        - golang-errorpages
    to-golangdesign:
      rule: Host(`golang.design`, `www.golang.design`) && (Path(`/`)||Path(`/index.html`)||Path(`/404.html`)||Path(`/sponsors.html`)||Path(`/icons/talkgo.png`)||Path(`/static/{name:(.*)}.js`)||Path(`/static/{name:(.*)}.css`)||Path(`/favicon.svg`)||Path(`/favicon.ico`)||Path(`/favicon.png`)||PathPrefix(`/history`)||PathPrefix(`/under-the-hood`)||PathPrefix(`/research`)||PathPrefix(`/miner`)||PathPrefix(`/go-questions`))
      tls:
        certResolver: golangdesignResolver
      middlewares:
        - gzipcompress
        - golang-errorpages
      service: nginx-golang
  middlewares:
    golang-redirector:
      redirectRegex:
        regex: "^(.*)changkun.de/golang(.*)"
        replacement: "https://golang.design/under-the-hood/${2}"
        permanent: true
    info-redirector:
      redirectRegex:
        regex: "^(.*)changkun.info/(.*)"
        replacement: "https://blog.changkun.de/${2}"
        permanent: true
    us-redirector:
      redirectRegex:
        regex: "^(.*)changkun.us/(.*)"
        replacement: "https://blog.changkun.de/${2}"
        permanent: true
    main-errorpages:
      errors:
        status:
          - "404"
        service: main
        query: "/404.html"
    golang-errorpages:
      errors:
        status:
          - "404"
        service: nginx-golang
        query: "/404.html"
    blog-errorpages:
      errors:
        status:
          - "404"
        service: blog
        query: "/404.html"
    auth:
      basicAuth:
        users:
          - "changkun:$2y$05$LDfRDyrTzFVaTw.KKz/9I.7Ko/OvZv2MBj9tWM4bf2VMu08xoATiK"
    gzipcompress:
      compress: {}
  services:
    login:
      loadBalancer:
        servers:
        - url: http://login
    main:
      loadBalancer:
        servers:
        - url: http://main
    talks:
      loadBalancer:
        servers:
        - url: http://talks
    nginx:
      loadBalancer:
        servers:
        - url: http://www
    nginx-golang:
      loadBalancer:
        servers:
        - url: http://www-golang
    blog:
      loadBalancer:
        servers:
        - url: http://blog
    redir:
      loadBalancer:
        servers:
        - url: http://redir
    golangdesign-redir:
      loadBalancer:
        servers:
        - url: http://golangdesign-redir
    urlstat:
      loadBalancer:
        servers:
        - url: http://urlstat
    midgard:
      loadBalancer:
        servers:
        - url: http://midgard
    upbot:
      loadBalancer:
        servers:
        - url: http://upbot
    gossa:
      loadBalancer:
        servers:
        - url: http://gossa
    code2img:
      loadBalancer:
        servers:
        - url: http://code2img
    polyred:
      loadBalancer:
        servers:
        - url: http://polyred
    void:
      loadBalancer:
        servers:
        - url: http://void
